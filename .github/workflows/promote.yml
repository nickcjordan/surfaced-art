name: Promote dev to main

on:
  push:
    branches: [dev]

concurrency:
  group: promote-dev-to-main
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write

jobs:
  promote:
    name: Ensure dev to main PR exists
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get pending commits
        id: commits
        run: |
          COMMITS=$(git log origin/main..origin/dev --oneline)
          printf 'commits<<EOF\n%s\nEOF\n' "$COMMITS" >> "$GITHUB_OUTPUT"
          if [ -z "$COMMITS" ]; then
            echo "has_commits=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_commits=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create or update dev to main PR
        if: steps.commits.outputs.has_commits == 'true'
        uses: actions/github-script@v8
        env:
          COMMITS: ${{ steps.commits.outputs.commits }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commits = process.env.COMMITS || '';

            const fence = '```';
            const hr = '---';
            const body = [
              '## Pending changes',
              '',
              'The following commits on `dev` are not yet on `main`:',
              '',
              fence,
              commits,
              fence,
              '',
              hr,
              '_This PR is maintained automatically. Merge with **rebase** to keep a linear history on `main`. After merging, `dev` will be fast-forwarded automatically._',
            ].join('\n');

            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:dev`,
              base: 'main',
              state: 'open',
            });

            if (pulls.length === 0) {
              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: 'dev',
                base: 'main',
                title: 'chore: promote dev to main',
                body,
              });
              console.log('Created new dev to main PR.');
            } else {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pulls[0].number,
                body,
              });
              console.log('Updated PR #' + pulls[0].number + '.');
            }
