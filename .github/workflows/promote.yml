name: Promote dev to main

on:
  push:
    branches: [dev]

concurrency:
  group: promote-dev-to-main
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write

jobs:
  promote:
    name: Ensure dev to main PR exists
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get pending commits
        id: commits
        run: |
          COMMITS=$(git log origin/main..origin/dev --oneline)
          printf 'commits<<EOF\n%s\nEOF\n' "$COMMITS" >> "$GITHUB_OUTPUT"
          if [ -z "$COMMITS" ]; then
            echo "has_commits=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_commits=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create or update dev to main PR
        if: steps.commits.outputs.has_commits == 'true'
        uses: actions/github-script@v8
        env:
          COMMITS: ${{ steps.commits.outputs.commits }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commits = process.env.COMMITS || '';

            // Parse commits into { type -> [subject, ...] } groups.
            // Conventional commit format: "sha type(scope): subject"
            const TYPE_LABELS = {
              feat:     'Features',
              fix:      'Bug Fixes',
              refactor: 'Refactoring',
              test:     'Tests',
              ci:       'CI / Automation',
              chore:    'Chores',
              docs:     'Documentation',
              perf:     'Performance',
              build:    'Build',
            };

            const groups = {};
            const other = [];

            for (const line of commits.split('\n').filter(Boolean)) {
              // Strip leading SHA (first token)
              const message = line.replace(/^[0-9a-f]+\s+/, '');
              const match = message.match(/^(\w+)(?:\([^)]+\))?!?:\s+(.+)/);
              if (match) {
                const type = match[1];
                const subject = match[2];
                const label = TYPE_LABELS[type];
                // Unknown conventional types go into other[] to avoid a
                // duplicate "Other" section alongside the fallback array.
                if (!label) {
                  other.push(subject);
                } else {
                  groups[label] = groups[label] || [];
                  groups[label].push(subject);
                }
              } else {
                other.push(message);
              }
            }

            const totalCommits = commits.split('\n').filter(Boolean).length;
            const title = `release: dev to main (${totalCommits} change${totalCommits === 1 ? '' : 's'})`;

            const sections = [];
            for (const [label, subjects] of Object.entries(groups)) {
              sections.push(`### ${label}\n${subjects.map(s => `- ${s}`).join('\n')}`);
            }
            if (other.length) {
              sections.push(`### Other\n${other.map(s => `- ${s}`).join('\n')}`);
            }

            const hr = '---';
            const body = [
              '## Summary',
              '',
              ...sections,
              '',
              hr,
              '_Auto-generated. This PR is updated on every push to `dev` and reflects all changes not yet on `main`._',
            ].join('\n');

            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:dev`,
              base: 'main',
              state: 'open',
            });

            if (pulls.length === 0) {
              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: 'dev',
                base: 'main',
                title,
                body,
              });
              console.log('Created new dev to main PR: ' + title);
            } else {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pulls[0].number,
                title,
                body,
              });
              console.log('Updated PR #' + pulls[0].number + ': ' + title);
            }
