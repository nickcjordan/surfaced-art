name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy-prod
  cancel-in-progress: false

permissions:
  contents: read

env:
  NODE_VERSION: '20'
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run db:generate --workspace=@surfaced-art/db

      - name: Build
        run: npm run build

      - name: Type Check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run test

      - name: Upload API artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-dist
          path: apps/api/dist/
          retention-days: 1

  terraform:
    name: Terraform Apply (prod)
    runs-on: ubuntu-latest
    needs: build
    environment: prod

    outputs:
      lambda_function_name: ${{ steps.output.outputs.lambda_function_name }}
      api_gateway_url: ${{ steps.output.outputs.api_gateway_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5'
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: infrastructure/terraform
        run: |
          terraform init \
            -backend-config="key=prod/terraform.tfstate"

      - name: Terraform Apply
        working-directory: infrastructure/terraform
        run: |
          terraform apply -auto-approve -input=false \
            -var-file="environments/prod.tfvars" \
            -var="db_password=${{ secrets.TF_VAR_db_password }}" \
            -var="google_client_id=${{ secrets.TF_VAR_google_client_id }}" \
            -var="google_client_secret=${{ secrets.TF_VAR_google_client_secret }}"

      - name: Get Terraform Outputs
        id: output
        working-directory: infrastructure/terraform
        run: |
          echo "lambda_function_name=$(terraform output -raw lambda_function_name)" >> $GITHUB_OUTPUT
          echo "api_gateway_url=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT

  deploy-lambda:
    name: Deploy Lambda
    runs-on: ubuntu-latest
    needs: [build, terraform]

    steps:
      - name: Download API artifact
        uses: actions/download-artifact@v7
        with:
          name: api-dist
          path: dist/

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create deployment package
        run: |
          cd dist
          zip -r ../lambda.zip .

      - name: Deploy to Lambda
        run: |
          aws lambda update-function-code \
            --function-name ${{ needs.terraform.outputs.lambda_function_name }} \
            --zip-file fileb://lambda.zip

      - name: Wait for Lambda update
        run: |
          aws lambda wait function-updated \
            --function-name ${{ needs.terraform.outputs.lambda_function_name }}

  migrate-database:
    name: Run Migrations
    runs-on: ubuntu-latest
    needs: [terraform, deploy-lambda]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run Prisma migrations
        working-directory: packages/db
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma migrate deploy

  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [terraform, deploy-lambda, migrate-database]

    steps:
      - name: Health Check
        run: |
          API_URL="${{ needs.terraform.outputs.api_gateway_url }}"
          echo "Checking health at $API_URL/health"

          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/health")
            if [ "$response" == "200" ]; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i: Got $response, retrying..."
            sleep 5
          done

          echo "Health check failed after 5 attempts"
          exit 1
