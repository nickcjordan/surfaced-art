name: Pull Request

on:
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: read

env:
  NODE_VERSION: '20'
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run db:generate --workspace=@surfaced-art/db

      - name: Build
        run: npm run build

      - name: Type Check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run test

      - name: Integration Tests
        run: npm run test:integration

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit (production)
        run: npm audit --omit=dev --audit-level=critical

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1'
          skip-files: 'package-lock.json'

      - name: Run Trivy IaC scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'infrastructure/terraform'
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1'

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  terraform-plan:
    name: Terraform Plan (prod)
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Terraform Init
        id: init
        working-directory: infrastructure/terraform
        run: |
          terraform init \
            -backend-config="key=prod/terraform.tfstate"

      - name: Terraform Validate
        id: validate
        working-directory: infrastructure/terraform
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        working-directory: infrastructure/terraform
        run: |
          terraform plan -no-color -input=false \
            -var-file="environments/prod.tfvars" \
            -var="db_password=${{ secrets.TF_VAR_db_password }}" \
            -var="google_client_id=${{ secrets.TF_VAR_google_client_id }}" \
            -var="google_client_secret=${{ secrets.TF_VAR_google_client_secret }}" \
            -var="alert_email_address=${{ secrets.TF_VAR_alert_email_address }}"
        continue-on-error: true

      - name: Comment Plan on PR
        uses: actions/github-script@v8
        if: github.event_name == 'pull_request'
        env:
          PLAN: ${{ steps.plan.outputs.stdout }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Plan (prod) ðŸ“–

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${process.env.PLAN || 'No changes detected'}
            \`\`\`

            </details>

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

  visual-qa:
    name: Visual QA
    runs-on: ubuntu-latest
    needs: [build-and-test]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Wait for Vercel preview deployment
        id: vercel-preview
        uses: patrickedqvist/wait-for-vercel-preview@v1.3.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 300
          check_interval: 15

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        working-directory: apps/web

      - name: Run visual QA tests
        run: npx playwright test --config=e2e/visual-qa.config.ts
        working-directory: apps/web
        env:
          VISUAL_QA_BASE_URL: ${{ steps.vercel-preview.outputs.url }}
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}

      - name: Upload visual QA artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-qa-${{ github.sha }}
          path: |
            apps/web/e2e/visual-qa/results/
            apps/web/e2e/visual-qa/report/
          retention-days: 14

  notify-actions-pr:
    name: Notify Actions (PR)
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, terraform-plan, visual-qa]
    if: always()
    continue-on-error: true
    timeout-minutes: 2

    steps:
      - name: Determine overall status
        id: status
        run: |
          # Check if any required job failed (terraform-plan may be skipped for drafts)
          BUILD_RESULT="${{ needs.build-and-test.result }}"
          SECURITY_RESULT="${{ needs.security-scan.result }}"
          TF_RESULT="${{ needs.terraform-plan.result }}"
          VISUAL_QA_RESULT="${{ needs.visual-qa.result }}"

          if [ "$BUILD_RESULT" = "failure" ] || [ "$SECURITY_RESULT" = "failure" ] || [ "$TF_RESULT" = "failure" ] || [ "$VISUAL_QA_RESULT" = "failure" ]; then
            echo "result=failure" >> "$GITHUB_OUTPUT"
            echo "emoji=âŒ" >> "$GITHUB_OUTPUT"
          else
            echo "result=success" >> "$GITHUB_OUTPUT"
            echo "emoji=âœ…" >> "$GITHUB_OUTPUT"
          fi

      - name: Get failure context
        id: failure
        if: steps.status.outputs.result == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: context.runId,
              });

              const failedJob = jobs.jobs.find(j => j.conclusion === 'failure');
              if (failedJob) {
                const failedStep = failedJob.steps?.find(s => s.conclusion === 'failure');
                core.setOutput('failed_step', failedStep ? failedStep.name : failedJob.name);
              } else {
                core.setOutput('failed_step', 'Unknown step');
              }
            } catch (error) {
              core.warning(`Failed to get failure context: ${error.message}`);
              core.setOutput('failed_step', 'Unknown step');
            }

      - name: Send to Slack actions channel
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_ACTIONS_WEBHOOK_URL }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          STATUS_EMOJI: ${{ steps.status.outputs.emoji }}
          STATUS_RESULT: ${{ steps.status.outputs.result }}
          FAILED_STEP: ${{ steps.failure.outputs.failed_step }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ "$STATUS_RESULT" = "success" ]; then
            TEXT=$(printf "%s PR checks passed: #%s %s\nAuthor: %s | <%s|View run>" \
              "$STATUS_EMOJI" "$PR_NUMBER" "$PR_TITLE" "$PR_AUTHOR" "$RUN_URL")
          else
            TEXT=$(printf "%s PR checks failed: #%s %s\nAuthor: %s | Failed step: %s | <%s|View run>" \
              "$STATUS_EMOJI" "$PR_NUMBER" "$PR_TITLE" "$PR_AUTHOR" "$FAILED_STEP" "$RUN_URL")
          fi

          PAYLOAD=$(jq -n --arg text "$TEXT" '{blocks: [{type: "section", text: {type: "mrkdwn", text: $text}}]}')

          curl -s --max-time 10 \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL" || true
